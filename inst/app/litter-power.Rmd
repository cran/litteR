## Power analysis

In this section, we quantify the power of the Wilcoxon signed rank test where the null hypothesis is

H<sub>0</sub>: distribution of litter data is symmetric about the baseline value

and the alternative hypothesis is

H<sub>1</sub>: distribution of litter data is less than the baseline value

We do this by means of Monte Carlo simulation for different values of the reduction (effect size), sample size and statistical significance (&alpha;). The procedure is as follows:

For each location, the time-series of the selected litter types are selected. For each of these time-series:

1. Estimate its mean abundance over the period of interest. This value is used as baseline value in the power analysis;
1. Multiply the abundances by a reduction factor _f_, where 0 < _f_ < 1 (effect size);
1. Draw _n_ (integer) values from the empirical cumulative distribution function (ECDF) of these reduced abundances;
1. Test if the simulated data are significantly below the baseline value by means of the Wilcoxon test;
1. Simulate a new data set and perform the test above many times (say, 100);
1. Estimate the power as the average number of times the null-hypothesis is rejected (_i.e._, p < &alpha;);
1. Repeat this procedure for different values for _n_, and _f_, given &alpha;

The reduction factor _f_ scales the monitoring data. The following expression holds:

mean(simulated data) &asymp; _f_ &times; mean(monitoring data) = _f_ &times; (baseline value)

Note that _f_ = 1 means no reduction (mean of the simulated data is approximately equal to the baseline value), and _f_ = 0 means absence of litter (_e.g._, a pristine clean beach).

```{r}
d <- d_ltr %>%
    group_by(type_name, region_name, country_code, location_name) %>% 
    summarise(n_surveys = n()) %>%
    ungroup %>%
    filter(n_surveys < MIN_SURVEYS) %>%
    distinct(region_name, country_code, location_name, n_surveys) %>%
    arrange(region_name, country_code, location_name)
```

> We will only perform power analysis for time-series with at least `r MIN_SURVEYS` surveys to sample from (as has been specified in the settings-file). Locations with an insufficient number of surveys `r if(nrow(d) == 0L) {"do not occur"} else {str_c("are:", toString(str_c(sQuote(d$location_name), " (", d$n_surveys, ")")))}`.


```{r}
set.seed(314)
d <- d_ltr %>%
    split(group_indices(., type_name, region_name, country_code, location_name)) %>%
    map_df(function(x) {
        if (nrow(x) < MIN_SURVEYS) {
            return(NULL)
        }
        list(
            n = 3:7 * 4,
            f = seq(
                from = 0.01 * RESOLUTION_EFFECT_SIZE, 
                to = 1.00 - 0.01 * RESOLUTION_EFFECT_SIZE, 
                by = 0.01 * RESOLUTION_EFFECT_SIZE)) %>%
            cross_df %>%
            pmap_df(function(n, f, baseline) {
                    tibble(
                        region_name = x$region_name[1], 
                        country_code = x$country_code[1], 
                        location_name = x$location_name[1],
                        type_name = x$type_name[1],
                        n = n,
                        f = f,
                        power = power(
                            wilcoxon(
                                x = f * x$abundance, 
                                mu = baseline, 
                                type = "less"
                            ),
                            n = n, 
                            alpha = ALPHA,
                            n_sim = N_SIM
                        )
                    )
                },
                baseline = mean(x$abundance)
            )
    })
```

The plots below give the power analysis results in case the number of surveys is greater than `r MIN_SURVEYS`. Reduction is given as a percentage of the baseline value, _i.e._, 100 &times; (1-f)


```{r fig.width=7, fig.height=4, out.width=900, eval=nrow(d)>0L}
d %>%
    left_join(
        d_stats %>% 
            select(region_name, country_code, location_name, type_name, ranking), 
        by = c("region_name", "country_code", "location_name", "type_name")) %>%
    group_by(type_name) %>%
    mutate(mean_ranking = mean(ranking)) %>%
    ungroup %>%
    split(group_indices(., mean_ranking, type_name, region_name, country_code, location_name)) %>%
    walk(function(x) {
        MAX_LEVELS <- 5L
        x <- x %>%
            mutate(f = factor(round(100*(1 - f)), ordered = TRUE)) %>%
            filter(f %in% levels(f)[1:min(MAX_LEVELS, nlevels(f))]) %>%
            mutate(f = factor(f)) %>%
            arrange(n, f)
        g <- ggplot(data = x) +
            geom_path(mapping = aes(x = n, y = power, colour = f, group = f), na.rm = TRUE) +
            scale_color_discrete(name = "reduction (%)") +
            scale_x_continuous(name = "# surveys") +
            scale_y_continuous(limits = c(0, 1), breaks = 0:5/5) +
            ggtitle(paste(x$location_name[1], x$type_name[1], sep = "  "))
        print(g)
    })
```
